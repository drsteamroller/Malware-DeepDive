# Dyre: Static Analysis

## 1. Detect it Easy + Strings

This time around I won't post the pictures because most of these are probably going to be PE files. After unzipping the archive, 8 files popped out. Some of them have names like fax_..., loader_..., and payload_... so I'll analyze files other than those. The top file alphabetically is also the largest, so I'll just start there. 

Throwing it into TrIDNET & DiE, they both say that it is unabashedly a PE file.

Its entropy is very high, which means its most likely been packed. Luckily there's a dump file provided, but I want to try to retrieve the actual executable file from memory dumping. With OllyDbg and OllyDump I dumped out from the entry point of the original file and saved it as Dyre_dump.exe. It now shows the .txt section as not packed, but the .rsrc section now reads as packed (which might mean it's been packed multiple times). I tried running it but it seems to be corrupted. I also dumped it using Scylla, which gives a dump file with the same exact size as the original.

The strings in the provided dump file have some interesting tidbits. They are "I'm DYRE!" and "Shit happens :)". There are some directory structures to keep in mind:

*/%s/%s/0/%s/%d/%s/*

*/%s/%s/%d/%s/*

*/%s/%s/%d/%s/%s/*

*/%s/%s/5/%s/%s/*


I also noticed a long list of websites, mostly with the prefix wildcard of "stun."... like stun.sipgate.net/stun1.voiceeclipse.net. STUN stands for Session Traversal Utilities for NAT, which is legitimately used for NAT traversal of VOiP. Malware uses this to get the public IPs of infected hosts behind a NAT. Of those, sipgate.net is listed in [1]'s "Stop Maladvertising" report, which is on Dyreza (which is another name for Dyre). This means that pretty much all of these websites are going to be the same.

I tried navigating to stunserver.org, but it redirects to a look-alike Microsoft website which hides your mouse and tells you that you have a virus.

One of the websites that doesn't seem to be connected to the STUN protocol is http://icanhazip.com which is a tool to show your public facing IP address, which the malware uses for obvious reasons.

Scrolling down further I see a bunch of HTTP GET and POST requests, but no content to those requests.

PEStudio didn't offer any extra info.

## Disassembly & Decompilation

Right away, it looks as if the "I'm DYRE!" and "Shit happens :)" aren't used for anything other than being something to be discovered. They are both fed into a lstrlenA() function, of which the return values aren't funneled into a variable.

Afterwards, the program retrieves 2 different paths, the current execution path is retrieved with GetModuleFileNameW, and stored into a character buffer that I renamed "DyreExecPath". The second is the path to AppData using the function SHGetFolderPathA- this is stored in a variable named AppDataPath.

(There's a lot of stuff to unpack with the main function which I'll get to in the next couple of days)

## References 

[1] https://unit42.paloaltonetworks.com/malware-trending-stun-awareness/