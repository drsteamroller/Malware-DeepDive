# Dyre: Static Analysis

## 1. Detect it Easy + Strings

This time around I won't post the pictures because most of these are probably going to be PE files. After unzipping the archive, 8 files popped out. Some of them have names like fax_..., loader_..., and payload_... so I'll analyze files other than those. The top file alphabetically is also the largest, so I'll just start there. 

Throwing it into TrIDNET & DiE, they both say that it is unabashedly a PE file.

Its entropy is very high, which means its most likely been packed. Luckily there's a dump file provided, but I want to try to retrieve the actual executable file from memory dumping. With OllyDbg and OllyDump I dumped out from the entry point of the original file and saved it as Dyre_dump.exe. It now shows the .txt section as not packed, but the .rsrc section now reads as packed (which might mean it's been packed multiple times). I tried running it but it seems to be corrupted. I also dumped it using Scylla, which gives a dump file with the same exact size as the original.

The strings in the provided dump file have some interesting tidbits. They are "I'm DYRE!" and "Shit happens :)". There are some directory structures to keep in mind:

*/%s/%s/0/%s/%d/%s/*

*/%s/%s/%d/%s/*

*/%s/%s/%d/%s/%s/*

*/%s/%s/5/%s/%s/*


I also noticed a long list of websites, mostly with the prefix wildcard of "stun."... like stun.sipgate.net/stun1.voiceeclipse.net. STUN stands for Session Traversal Utilities for NAT, which is legitimately used for NAT traversal of VOiP. Malware uses this to get the public IPs of infected hosts behind a NAT. Of those, sipgate.net is listed in [1]'s "Stop Maladvertising" report, which is on Dyreza (which is another name for Dyre). This means that pretty much all of these websites are going to be the same.

I tried navigating to stunserver.org, but it redirects to a look-alike Microsoft website which hides your mouse and tells you that you have a virus.

One of the websites that doesn't seem to be connected to the STUN protocol is http://icanhazip.com which is a tool to show your public facing IP address, which the malware uses for obvious reasons.

Scrolling down further I see a bunch of HTTP GET and POST requests, but no content to those requests.

PEStudio didn't offer any extra info.

## Disassembly & Decompilation

Right away, it looks as if the "I'm DYRE!" and "Shit happens :)" aren't used for anything other than being something to be discovered. They are both fed into a lstrlenA() function, of which the return values aren't funneled into a variable.

Afterwards, the program retrieves 2 different paths, the current execution path is retrieved with GetModuleFileNameW, and stored into a character buffer that I renamed "DyreExecPath". The second is the path to AppData using the function SHGetFolderPathA- this is stored in a variable named AppDataPath. It seems to go up a folder from "Roaming" and then switch into "Local" then stores that path into a different string which I've named ADLocalPath. After that, it appends "cmd.exe" to AppDataPath.

> As an aside I've noticed that all the strings, save for the "I'm Dyre"/"Shit happens :)" strings, are all wide character width strings meaning they use 16 bit width storage for characters. This makes sense since the origin of this malware is Russia, so it would need to use these longer character widths to code it in their native language.

I've also been noticing that this malware likes to use operations in if statements kind of like this direct example:

```c
  if ((DAT_0040400c != (HANDLE)0x0) ||
     (DAT_0040400c = HeapCreate(0x40000,0x400000,0), DAT_0040400c != (HANDLE)0x0)) {
    _DAT_00404010 = _DAT_00404010 + 1;
  }
```

I'm almost certain this if statement always runs because the conditional is always true, either the heap has already been created, or it creates it and returns true or false based on if the function was successful.

After heap creation, the program then compares AppDataPath and DyreExecPath and if they are the same it feeds AppDataPath into some function, and if that function returns a nonzero integer, it feeds DyreExecPath into a different function. After that is finished, it exits the program altogether. This could be a main run of the program, but since I'm not running Dyre from AppData, I'll skip this for now.

If AppDataPath and DyreExecPath are not the same, the program calls the function OpenMutexW [2] with the SYNCHRONIZE [3] flag set and the name "Xider78". Searching "Xider78" just gives signatures for Dyre, so this is unique to this malware. Searching around more, I found [4] says that Xider is a browser modifier, so I wonder if Dyre names itself as Xider78 as a process/mutex. This is apparent because if opening the mutex is successful, the program simply exits.

Check for loop, looks to be obfuscation by deleting a file repeatedly

## References 

[1] https://unit42.paloaltonetworks.com/malware-trending-stun-awareness/

[2] https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-openmutexw

[3] https://docs.microsoft.com/en-us/windows/win32/sync/synchronization-object-security-and-access-rights

[4] https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=BrowserModifier:Win32/Xider
