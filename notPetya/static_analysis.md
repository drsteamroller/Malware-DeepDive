# notPetya: Static Analysis

## 1. TrIDNET & Detect it Easy

Let's first figure out what we've got. When I unzipped the "theZoo" archive, it presented me with 2 binary files. Sparing the long hex names, the files are 788 KB and 226 KB. Let's take a look at TrIDNET and Detect it Easy to see what their actual file definitions are:

> **Larger File**<p>
<img title="Larger File [TrIDNET]" src="images/tridnetLF.png">
<img title="Larger File [Detect it Easy]" src="images/diteLF.png">
</p>

> **Smaller File**<p>
<img title="Smaller File [TrIDNET]" src="images/tridnetSF.png">
<img title="Smaller File [Detect it Easy]" src="images/diteSF.png">
</p>

So it seems as if the larger file is the main executable, and the smaller one is something peculiar. Basing my thoughts off first looks, I would guess that this file is injected somewhere (the Control Panel perhaps) and could be a way to obtain root/admin priveleges. That or it could be 2 different versions of Petya. We'll know for sure when we get to dynamic analysis.

A very top-level research of CPL files **[1]** tells us that they are used as an interface for system drivers. It isn't super uncommon that 3rd party hardware/software include these CPLs as part of their driver- for example, the on-board network adapter for a computer would need to include one for troubleshooting. This hints towards a possible method for persistence. 

## 2. Strings

As you do in digital forensics, I copied the two files to a separate workspace and renamed the larger file to "PetyaPayload" and the smaller one "PetyaPersist". The latter might change as we get a better idea as to what it's purpose is.

Scrolling on through the strings of PetyaPayload, I found XML-like structure similar to what CPL files are supposed to look like **[2]**. It could be that the program is broken up between 2 executables, or like I said before, it could be 2 versions of Petya. 

The content however is interesting. I see that it calls itself "Microsoft.Windows.Common-Controls", and there's a "<description>" with the text "WinRAR SFX module". This could be part of the masquerading/social engineering that ransomwares like Petya and Wana Decrypt0r rely on in order to infect machines. Nothing else stuck out to me in the strings of the "payload", let's move onto the "persist" file.

I only really found the same CPL structure with the same exact information in PetyaPersist, which leads me to believe these are both Petya, but we still have more to look through.

## 3. Disassembly & Decompilation

Jumping right into Ghidra for decompilation, the entry function at a glance looks like a bunch of initializations, with error handling that will be explored later. Two important variable declarations that are used in the main function are a integer, which I've renamed "statusCodeFetcher", and a \_STARTUPINFOW struct **[3]** I aptly renamed "StartupInfo". statusCodeFetcher is used to grab the return codes from each of the initializers, and then it is compared in if statements to determine if the program needs to exit. StartupInfo grabs the \_STARTUPINFOW struct that returns from the GetStartupInfoW function. This is mainly just housekeeping on C-Runtime's part, but it's nice to explore this as a novice, and to see if the malware authors including anything subtle.

### A] Initializers



## References

[1] https://support.microsoft.com/en-us/topic/description-of-control-panel-cpl-files-4dc809cd-5063-6c6d-3bee-d3f18b2e0176

[2] https://docs.fileformat.com/system/cpl/#:~:text=A%20CPL%20file%20is%20short,Displays%2C%20Networking%2C%20amongst%20others

[3] https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/ns-processthreadsapi-startupinfow (StartupInfoW struct)

[4] https://docs.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapsetinformation (HeapSetInformation function)

[5] https://docs.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapcreate (HeapCreate function)