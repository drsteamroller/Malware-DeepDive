# notPetya: Dynamic Analysis

Most people probably know and have seen the splash screen that notPetya displays, but its nice to explore the effects in detail.

Upon changing the larger notPetya file from a .BIN to a .EXE, it changes its icon to its socially engineered picture:

<img title="PDF.exe??" src="images/pdfexe.png">

Windows ships its operating system with the option to see file extensions **turned off**. This is why this attack was so successful against people who left this option set to default off. It just appears as if its a pdf, and say it was sent from an email that was similar to the person's boss/superior, they might try to open it. The only thing that is suspicious is that the file asks for admin privileges. This was probably mitigated through some careful social engineering like mentioned before.

Before I run the larger file, here is what the icon changes to for the smaller file:

<img title="installer.exe??" src="images/installerexe.png">

This one looks like an installer, so this one was probably circulated more in the standard virus scene of masquerading as legitimate software.

## Dry Run

Now I'm gonna run them both before I put them through some other dynamic tools.

A little bit after giving the pdf Petya admin privileges, the VM crashes. This is the screen I get after restarting it:

<img title="fake chdsk" src="images/fakechdsk.png">

<img title="Splash Screen" src="images/petya.png">

<img title="Hacker's Message" src="images/goodluck.png">

Running the smaller file yields the same results. I'm not completely sure, but I think that it ran faster, so I wonder if the EternalBlue exploit (how this malware typically spreads) is absent in this smaller version, but that's just conjecture.

## Cuckoo Sanbox (cuckoo.cert.ee)

Jumping straight into the output, the first bit of information that's pertinent is the Yara signatures. The rules (descriptions) that were flagged by yara were [checks if being debugged; disable antivirus, communication over HTTP and DGA, takes screenshot, create or check mutex, afftect system registries and tokens, and affects private profile]. Among all of these, taking a screenshot seems to be the most out of the blue. The screenshot provided by Cuckoo is of the desktop. My idea is that it could be a way for the hackers to prove that they were the ones who took over the victims computer by showing them a picture of their desktop. Storing pictures seems redundant for any sort of information gathering, since if they wanted to take file info from files on the desktop, they could just grab it from the files themselves instead of taking a screenshot. 

Moving onto the next signature, it allocates rwx memory - which Cuckoo says that it uses to unpack itself. This might be why there were a few broken functions, if the file was partially packed. This is confirmed with the next flag, that the file entropy was very high - \~0.568.

After this I saw that it sets its privilege to be able to shut down the machine. This is expected.

The next section is full of NTCreateFile and NTWriteFile, which are all the same. The NTWriteFile always has a buffer full of '7's and Cuckoo says that it might be installing a bootkit via raw harddisk modifications. It's probably overwriting the buffer into the master boot record (MBR) so it can bypass Window's boot when it shuts down.

The next 2 sections were antivirus tool flags which tells us nothing new.